{% extends "base.html" %}
{% block title %}{{ proposal.title }} — AI Proposal{% endblock %}

{% block content %}
<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.25rem">
    <div>
        <div style="font-size:.8rem;color:#7f8c8d;margin-bottom:.25rem">
            <a href="{{ url_for('ai_proposals') }}" style="color:#7f8c8d;text-decoration:none">AI Proposals</a>
            &rsaquo; {{ proposal.title[:60] }}{% if proposal.title|length > 60 %}…{% endif %}
        </div>
        <h1>{{ proposal.title }}</h1>
        {% if proposal.opp_title %}<p class="subtitle" style="margin-top:.15rem">{{ proposal.opp_title }} &bull; {{ proposal.agency or '—' }}</p>{% endif %}
    </div>
    <div style="display:flex;gap:.5rem;align-items:center">
        <span style="background:#2c3e50;color:#fff;padding:.2rem .6rem;border-radius:3px;font-size:.72rem;font-weight:700;text-transform:uppercase">
            {{ (proposal.status or 'draft').replace('_',' ') }}
        </span>
        {% if proposal.due_date %}
        <span style="font-size:.8rem;color:#7f8c8d">Due {{ proposal.due_date[:10] }}</span>
        {% endif %}
    </div>
</div>

{# ── Stats bar ─────────────────────────────────────────────────────────────── #}
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:.75rem;margin-bottom:1.25rem">
    <div class="card" style="padding:.75rem;text-align:center">
        <div style="font-size:1.6rem;font-weight:700;color:#2c3e50">{{ sections|length }}</div>
        <div style="font-size:.75rem;color:#7f8c8d">AI Sections</div>
    </div>
    <div class="card" style="padding:.75rem;text-align:center">
        <div style="font-size:1.6rem;font-weight:700;color:#27ae60">{{ sections|selectattr('hitl_status','equalto','accepted')|list|length }}</div>
        <div style="font-size:.75rem;color:#7f8c8d">Accepted</div>
    </div>
    <div class="card" style="padding:.75rem;text-align:center">
        <div style="font-size:1.6rem;font-weight:700;color:#e67e22">{{ sections|selectattr('hitl_status','equalto','pending')|list|length }}</div>
        <div style="font-size:.75rem;color:#7f8c8d">Pending Review</div>
    </div>
    <div class="card" style="padding:.75rem;text-align:center">
        <div style="font-size:1.6rem;font-weight:700;color:#2980b9">{{ docs|length }}</div>
        <div style="font-size:.75rem;color:#7f8c8d">Documents</div>
    </div>
    <div class="card" style="padding:.75rem;text-align:center"
         title="{% set total_req = (req_status.get('addressed',0) + req_status.get('not_addressed',0) + req_status.get('partial',0)) %}{% if not total_req %}Requirements not yet extracted — upload an RFP document to auto-detect requirements{% else %}{{ req_status.get('addressed',0) }} of {{ total_req }} requirements addressed{% endif %}">
        {% set total_req = (req_status.get('addressed',0) + req_status.get('not_addressed',0) + req_status.get('partial',0)) %}
        {% if total_req %}
        <div style="font-size:1.6rem;font-weight:700;color:#8e44ad">{{ req_status.get('addressed',0) }}/{{ total_req }}</div>
        <div style="font-size:.75rem;color:#7f8c8d">Reqs Addressed</div>
        {% else %}
        <div style="font-size:1rem;font-weight:600;color:#bdc3c7">—</div>
        <div style="font-size:.75rem;color:#bdc3c7">Reqs
            <span style="display:block;font-size:.68rem">(upload RFP to extract)</span>
        </div>
        {% endif %}
    </div>
</div>

<div style="display:grid;grid-template-columns:1fr 320px;gap:1.25rem">

{# ── Left: Sections + HITL ─────────────────────────────────────────────────── #}
<div>

{# Generate section form #}
<section class="card" style="margin-bottom:1.25rem">
    <h2 style="margin-bottom:.75rem">Generate New Section</h2>
    <form id="generate-form">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:.75rem">
            <div>
                <label style="display:block;font-size:.8rem;margin-bottom:.2rem">Section Title <span style="color:#e74c3c">*</span></label>
                <input id="gen-title" type="text" placeholder="e.g., Technical Approach"
                       style="width:100%;padding:.4rem;border:1px solid #ddd;border-radius:3px;font-size:.85rem">
            </div>
            <div>
                <label style="display:block;font-size:.8rem;margin-bottom:.2rem">Volume</label>
                <select id="gen-volume" style="width:100%;padding:.4rem;border:1px solid #ddd;border-radius:3px;font-size:.85rem">
                    <option value="technical">Technical</option>
                    <option value="management">Management</option>
                    <option value="past_performance">Past Performance</option>
                    <option value="cost">Cost / Price</option>
                    <option value="executive_summary">Executive Summary</option>
                    <option value="other">Other</option>
                </select>
            </div>
        </div>
        <div style="margin-bottom:.75rem">
            <label style="display:block;font-size:.8rem;margin-bottom:.2rem">Pricing Scenario (for cost volumes)</label>
            <select id="gen-pricing" style="width:100%;padding:.4rem;border:1px solid #ddd;border-radius:3px;font-size:.85rem">
                <option value="">— None —</option>
                {% for p in pricing_scenarios %}
                <option value="{{ p.id }}">{{ p.name }} — ${{ '{:,.0f}'.format(p.total_price or 0) }} ({{ p.contract_type or '' }})</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" id="gen-btn"
                style="background:#2980b9;color:#fff;border:none;padding:.45rem 1.1rem;border-radius:4px;cursor:pointer;font-size:.85rem">
            ⚡ Generate Section
        </button>
        <span id="gen-status" style="margin-left:.75rem;font-size:.8rem;color:#7f8c8d"></span>
    </form>
</section>

{# Sections list #}
{% if sections %}
{% for s in sections %}
<section class="card" style="margin-bottom:1rem" id="section-{{ s.id }}">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.6rem">
        <div>
            <strong>{{ s.section_title }}</strong>
            <span style="margin-left:.5rem;font-size:.75rem;background:#ecf0f1;padding:.1rem .4rem;border-radius:3px;text-transform:uppercase">{{ s.volume }}</span>
            {% if s.section_number %}<span style="margin-left:.3rem;font-size:.72rem;color:#7f8c8d">§{{ s.section_number }}</span>{% endif %}
        </div>
        <div style="display:flex;align-items:center;gap:.4rem">
            {% set qs = s.get('quality_score') %}
            {% if qs is not none %}
            <span title="AI quality score" style="font-size:.75rem;font-weight:700;color:{% if qs >= 70 %}#27ae60{% elif qs >= 50 %}#e67e22{% else %}#e74c3c{% endif %}">
                {{ qs }}%
            </span>
            {% endif %}
            {% if s.hitl_status == 'accepted' %}
            <span style="background:#27ae60;color:#fff;padding:.1rem .5rem;border-radius:3px;font-size:.72rem;font-weight:700">✓ ACCEPTED</span>
            {% elif s.hitl_status == 'revised' %}
            <span style="background:#3498db;color:#fff;padding:.1rem .5rem;border-radius:3px;font-size:.72rem;font-weight:700">✎ REVISED</span>
            {% elif s.hitl_status == 'rejected' %}
            <span style="background:#e74c3c;color:#fff;padding:.1rem .5rem;border-radius:3px;font-size:.72rem;font-weight:700">✗ REJECTED</span>
            {% else %}
            <span style="background:#e67e22;color:#fff;padding:.1rem .5rem;border-radius:3px;font-size:.72rem;font-weight:700">⏳ PENDING</span>
            {% endif %}
        </div>
    </div>

    {# Content toggle #}
    <div id="content-{{ s.id }}" style="background:#f8f9fa;border-radius:4px;padding:.75rem;font-size:.82rem;line-height:1.6;max-height:200px;overflow-y:auto;white-space:pre-wrap;font-family:inherit;margin-bottom:.6rem;color:#2c3e50">{{ s.content_draft or '(no draft yet)' }}</div>

    {# Review notes field #}
    {% if s.hitl_status == 'pending' %}
    <div style="margin-bottom:.5rem">
        <input type="text" id="notes-{{ s.id }}" placeholder="Review notes (optional)"
               style="width:100%;padding:.35rem;border:1px solid #ddd;border-radius:3px;font-size:.8rem">
    </div>
    <div style="display:flex;gap:.4rem;flex-wrap:wrap">
        <button onclick="reviewSection('{{ s.id }}','accept')"
                style="background:#27ae60;color:#fff;border:none;padding:.3rem .75rem;border-radius:3px;cursor:pointer;font-size:.8rem">
            ✓ Accept
        </button>
        <button onclick="reviewSection('{{ s.id }}','revise')"
                style="background:#3498db;color:#fff;border:none;padding:.3rem .75rem;border-radius:3px;cursor:pointer;font-size:.8rem">
            ✎ Accept with Revisions
        </button>
        <button onclick="reviewSection('{{ s.id }}','reject')"
                style="background:#e74c3c;color:#fff;border:none;padding:.3rem .75rem;border-radius:3px;cursor:pointer;font-size:.8rem">
            ✗ Reject
        </button>
        <button onclick="reviewSection('{{ s.id }}','regenerate')"
                style="background:#7f8c8d;color:#fff;border:none;padding:.3rem .75rem;border-radius:3px;cursor:pointer;font-size:.8rem">
            ↻ Regenerate
        </button>
    </div>
    {% else %}
    <div style="display:flex;gap:.4rem">
        {% if s.hitl_reviewer %}<span style="font-size:.75rem;color:#7f8c8d">Reviewed by {{ s.hitl_reviewer }}{% if s.hitl_reviewed_at %} on {{ s.hitl_reviewed_at[:10] }}{% endif %}</span>{% endif %}
        {% if s.hitl_notes %}<span style="font-size:.75rem;color:#7f8c8d"> &bull; {{ s.hitl_notes }}</span>{% endif %}
    </div>
    {% endif %}
</section>
{% endfor %}
{% else %}
<div class="card" style="text-align:center;padding:2.5rem">
    <p style="color:#7f8c8d">No AI sections yet. Use the form above to generate your first section.</p>
</div>
{% endif %}

</div>

{# ── Right sidebar ──────────────────────────────────────────────────────────── #}
<div>
    {# Documents #}
    <section class="card" style="margin-bottom:1rem">
        <h3 style="margin-bottom:.5rem;font-size:.9rem">RFP Documents</h3>
        {% if docs %}
        {% for d in docs %}
        <div style="display:flex;justify-content:space-between;align-items:center;padding:.3rem 0;border-bottom:1px solid #f0f0f0;font-size:.8rem">
            <span title="{{ d.filename }}">{{ d.filename[:30] }}{% if d.filename|length > 30 %}…{% endif %}</span>
            <span style="color:{% if d.vectorized %}#27ae60{% else %}#e67e22{% endif %}">
                {% if d.vectorized %}✓ indexed{% else %}not indexed{% endif %}
            </span>
        </div>
        {% endfor %}
        {% else %}
        <p style="color:#7f8c8d;font-size:.8rem">No documents uploaded yet.</p>
        {% endif %}
        <a href="{{ url_for('rfx_documents') }}?proposal_id={{ proposal.id }}"
           style="display:block;margin-top:.5rem;font-size:.78rem;color:#2980b9;text-decoration:none">
            + Upload documents
        </a>
    </section>

    {# Win Themes #}
    {% if win_themes %}
    <section class="card" style="margin-bottom:1rem">
        <h3 style="margin-bottom:.5rem;font-size:.9rem">Win Themes</h3>
        {% for t in win_themes[:5] %}
        <div style="font-size:.78rem;padding:.25rem 0;border-bottom:1px solid #f0f0f0;color:#2c3e50">• {{ t }}</div>
        {% endfor %}
    </section>
    {% endif %}

    {# Requirements status #}
    <section class="card" style="margin-bottom:1rem">
        <h3 style="margin-bottom:.5rem;font-size:.9rem">Requirements Coverage</h3>
        {% set total = (req_status.get('addressed',0) + req_status.get('not_addressed',0) + req_status.get('partial',0)) %}
        {% if total %}
        {% set pct = ((req_status.get('addressed',0) / total) * 100)|round(0)|int %}
        <div style="background:#ecf0f1;border-radius:4px;height:8px;margin-bottom:.4rem">
            <div style="background:#27ae60;height:8px;border-radius:4px;width:{{ pct }}%"></div>
        </div>
        <div style="font-size:.78rem;color:#7f8c8d">{{ req_status.get('addressed',0) }} / {{ total }} addressed ({{ pct }}%)</div>
        {% else %}
        <p style="font-size:.78rem;color:#7f8c8d">No requirements extracted yet.</p>
        {% endif %}
        <a href="{{ url_for('rfx_requirements') }}?proposal_id={{ proposal.id }}"
           style="display:block;margin-top:.4rem;font-size:.78rem;color:#2980b9;text-decoration:none">
            View all requirements →
        </a>
    </section>

    {# CUI banner #}
    <div style="background:#2c3e50;color:#fff;font-size:.7rem;text-align:center;padding:.35rem;border-radius:4px;letter-spacing:.05em">
        CUI // SP-PROPIN
    </div>
</div>

</div>{# end grid #}

<style>
#rfx-toast {
    position:fixed;bottom:1.5rem;right:1.5rem;z-index:9999;
    padding:.75rem 1.25rem;border-radius:6px;font-size:.875rem;
    color:#fff;max-width:420px;box-shadow:0 4px 12px rgba(0,0,0,.25);
    display:none;transition:opacity .3s;
}
#rfx-toast.success { background:#27ae60; }
#rfx-toast.error   { background:#c0392b; }
#rfx-toast.info    { background:#2980b9; }
</style>
<div id="rfx-toast"></div>

<script>
const PROPOSAL_ID = "{{ proposal.id }}";

function showToast(msg, type="info", duration=4000) {
    const t = document.getElementById("rfx-toast");
    t.textContent = msg;
    t.className = type;
    t.style.display = "block";
    t.style.opacity = "1";
    clearTimeout(t._timer);
    t._timer = setTimeout(() => {
        t.style.opacity = "0";
        setTimeout(() => { t.style.display = "none"; }, 300);
    }, duration);
}

document.getElementById("generate-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const title = document.getElementById("gen-title").value.trim();
    if (!title) { showToast("Section title is required.", "error"); return; }
    const btn = document.getElementById("gen-btn");
    const status = document.getElementById("gen-status");
    btn.disabled = true;
    btn.textContent = "⏳ Generating…";
    status.textContent = "AI is drafting your section — this takes 15–30 seconds.";
    status.style.color = "#2980b9";

    try {
        const resp = await fetch("/api/rfx/ai/generate", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                proposal_id: PROPOSAL_ID,
                section_title: title,
                volume: document.getElementById("gen-volume").value,
                pricing_scenario_id: document.getElementById("gen-pricing").value || null,
            })
        });
        const data = await resp.json();
        if (!resp.ok || data.error) {
            showToast(data.error || "AI generation is temporarily unavailable. Please try again or contact your system administrator.", "error", 6000);
        } else {
            showToast("✓ Section generated — reviewing now.", "success");
            setTimeout(() => location.reload(), 800);
        }
    } catch(err) {
        showToast("Request failed: " + err.message, "error");
    } finally {
        btn.disabled = false;
        btn.textContent = "⚡ Generate Section";
        status.textContent = "";
    }
});

async function reviewSection(sectionId, action) {
    const btn = event && event.target;
    if (btn) { btn.disabled = true; btn.style.opacity = ".6"; }
    const notes = document.getElementById("notes-" + sectionId)?.value || "";
    try {
        const resp = await fetch("/api/rfx/ai/sections/" + sectionId + "/review", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ action, feedback: notes, reviewer: "user" })
        });
        const data = await resp.json();
        if (!resp.ok || data.error) {
            showToast("✗ Unable to save your review — please try again.", "error", 5000);
            if (btn) { btn.disabled = false; btn.style.opacity = "1"; }
        } else {
            const labels = { accept: "✓ Section accepted", reject: "✗ Section rejected", revise: "✎ Revisions saved", regenerate: "↻ Regenerating…" };
            showToast(labels[action] || "Review saved.", "success");
            setTimeout(() => location.reload(), 800);
        }
    } catch(err) {
        showToast("Request failed: " + err.message, "error");
        if (btn) { btn.disabled = false; btn.style.opacity = "1"; }
    }
}
</script>
{% endblock %}
