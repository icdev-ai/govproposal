{% extends "base.html" %}
{% block title %}Fine-Tuning — {{ app_name }}{% endblock %}

{% block content %}
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem">
    <div>
        <h1>Fine-Tuning</h1>
        <p class="subtitle">Unsloth / LoRA adapter training — runs locally via Python subprocess</p>
    </div>
</div>

{# ── Dependency notice ─────────────────────────────────────────────────────── #}
<div class="card" style="background:#fef9e7;border-left:4px solid #f39c12;margin-bottom:1.25rem;padding:.75rem 1rem">
    <strong style="font-size:.85rem">Requirements:</strong>
    <span style="font-size:.82rem;color:#7f8c8d"> Python packages: <code>unsloth</code>, <code>transformers</code>, <code>datasets</code>, <code>trl</code>, <code>peft</code> — GPU recommended. Install via <code>pip install unsloth</code>.</span>
</div>

<div style="display:grid;grid-template-columns:1fr 300px;gap:1.25rem">

{# ── Left: Start job + Jobs list ───────────────────────────────────────────── #}
<div>

{# Start job form #}
<section class="card" style="margin-bottom:1.25rem">
    <h2 style="margin-bottom:.75rem">Start Fine-Tuning Job</h2>
    <form id="finetune-form">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:.75rem">
            <div>
                <label style="display:block;font-size:.8rem;margin-bottom:.2rem">Job Name <span style="color:#e74c3c">*</span></label>
                <input id="job-name" type="text" placeholder="e.g., proposal-v2-lora"
                       style="width:100%;padding:.4rem;border:1px solid #ddd;border-radius:3px;font-size:.85rem">
            </div>
            <div>
                <label style="display:block;font-size:.8rem;margin-bottom:.2rem">Model Config</label>
                <select id="job-model"
                        style="width:100%;padding:.4rem;border:1px solid #ddd;border-radius:3px;font-size:.85rem">
                    <option value="">— Default (from DB) —</option>
                    {% for m in models %}
                    <option value="{{ m.id }}">{{ m.model_name }} ({{ m.base_model }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:.75rem;margin-bottom:.75rem">
            <div>
                <label style="display:block;font-size:.8rem;margin-bottom:.2rem">Epochs</label>
                <input id="job-epochs" type="number" value="3" min="1" max="20"
                       style="width:100%;padding:.4rem;border:1px solid #ddd;border-radius:3px;font-size:.85rem">
            </div>
            <div>
                <label style="display:block;font-size:.8rem;margin-bottom:.2rem">Batch Size</label>
                <input id="job-batch" type="number" value="4" min="1" max="32"
                       style="width:100%;padding:.4rem;border:1px solid #ddd;border-radius:3px;font-size:.85rem">
            </div>
            <div>
                <label style="display:block;font-size:.8rem;margin-bottom:.2rem">Learning Rate</label>
                <input id="job-lr" type="text" value="2e-4"
                       style="width:100%;padding:.4rem;border:1px solid #ddd;border-radius:3px;font-size:.85rem">
            </div>
        </div>
        <button type="submit" id="ft-btn"
                style="background:#27ae60;color:#fff;border:none;padding:.45rem 1.1rem;border-radius:4px;cursor:pointer;font-size:.85rem">
            ▶ Start Job
        </button>
        <span id="ft-status" style="margin-left:.75rem;font-size:.8rem;color:#7f8c8d"></span>
    </form>
</section>

{# Jobs table #}
<section class="card">
    <h2 style="margin-bottom:.75rem">Job History ({{ jobs|length }})</h2>
    {% if jobs %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Job Name</th>
                <th>Config</th>
                <th>Status</th>
                <th>Progress</th>
                <th>Started</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for j in jobs %}
        <tr id="job-row-{{ j.id }}">
            <td>
                <strong>{{ j.job_name or j.id[:8] }}</strong>
                {% if j.output_model_path %}<br><small style="color:#7f8c8d;font-family:monospace">{{ j.output_model_path[-40:] }}</small>{% endif %}
            </td>
            <td style="font-size:.78rem">{{ j.config_name or '—' }}</td>
            <td>
                {% if j.status == 'completed' %}
                <span style="color:#27ae60;font-weight:700">✓ Completed</span>
                {% elif j.status == 'running' %}
                <span style="color:#2980b9;font-weight:700">⟳ Running</span>
                {% elif j.status == 'failed' %}
                <span style="color:#e74c3c;font-weight:700">✗ Failed</span>
                {% elif j.status == 'queued' %}
                <span style="color:#e67e22">⏳ Queued</span>
                {% else %}
                <span style="color:#7f8c8d">{{ j.status or '—' }}</span>
                {% endif %}
            </td>
            <td style="font-size:.78rem">
                {% if j.current_epoch and j.total_epochs %}
                Epoch {{ j.current_epoch }}/{{ j.total_epochs }}
                {% if j.train_loss %}&bull; loss {{ '%.4f'|format(j.train_loss|float) }}{% endif %}
                {% else %}—{% endif %}
            </td>
            <td style="font-size:.75rem;white-space:nowrap">{{ (j.started_at or j.created_at or '')[:16] or '—' }}</td>
            <td>
                {% if j.status == 'running' %}
                <button onclick="checkJobStatus('{{ j.id }}')"
                        style="background:#2980b9;color:#fff;border:none;padding:.2rem .5rem;border-radius:3px;cursor:pointer;font-size:.72rem">
                    Refresh
                </button>
                {% elif j.status in ('completed',) and j.output_model_path %}
                <span style="font-size:.72rem;color:#27ae60">Ready</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color:#7f8c8d;font-size:.85rem">No jobs yet. Start your first fine-tuning run above.</p>
    {% endif %}
</section>

</div>

{# ── Right: Corpus docs ────────────────────────────────────────────────────── #}
<div>
    <section class="card">
        <h3 style="margin-bottom:.5rem;font-size:.9rem">Training Corpus ({{ corpus_docs|length }})</h3>
        <p style="font-size:.78rem;color:#7f8c8d;margin-bottom:.5rem">
            Accepted proposal sections and uploaded corpus documents are used as fine-tuning data.
        </p>
        {% if corpus_docs %}
        {% for d in corpus_docs %}
        <div style="display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid #f0f0f0;font-size:.78rem">
            <span title="{{ d.filename }}">{{ d.filename[:28] }}{% if d.filename|length > 28 %}…{% endif %}</span>
            <span style="color:#7f8c8d;text-transform:uppercase;font-size:.7rem">{{ d.doc_type or '—' }}</span>
        </div>
        {% endfor %}
        {% else %}
        <p style="font-size:.78rem;color:#7f8c8d">No corpus documents yet.</p>
        {% endif %}
        <a href="{{ url_for('rfx_documents') }}"
           style="display:block;margin-top:.5rem;font-size:.78rem;color:#2980b9;text-decoration:none">
            + Upload corpus documents
        </a>
    </section>

    <section class="card" style="margin-top:1rem">
        <h3 style="margin-bottom:.5rem;font-size:.9rem">About Fine-Tuning</h3>
        <div style="font-size:.78rem;color:#7f8c8d;line-height:1.6">
            <p style="margin-bottom:.4rem">Fine-tuning adapts a base LLM to your organization's proposal voice and style using LoRA (Low-Rank Adaptation) via Unsloth.</p>
            <p style="margin-bottom:.4rem"><strong>Process:</strong> Accepted sections → JSONL training file → LoRA training → adapter saved locally.</p>
            <p>No data leaves your environment. GPU optional but strongly recommended (4-bit quantization).</p>
        </div>
    </section>

    <div style="margin-top:1rem;background:#2c3e50;color:#fff;font-size:.7rem;text-align:center;padding:.35rem;border-radius:4px;letter-spacing:.05em">
        CUI // SP-PROPIN
    </div>
</div>

</div>

<script>
document.getElementById("finetune-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const name = document.getElementById("job-name").value.trim();
    if (!name) { alert("Job name is required."); return; }
    const btn = document.getElementById("ft-btn");
    const status = document.getElementById("ft-status");
    btn.disabled = true; btn.textContent = "Starting…";
    status.textContent = "Queuing job…";

    const resp = await fetch("/api/rfx/finetune/start", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            job_name: name,
            model_config_id: document.getElementById("job-model").value || null,
            epochs: parseInt(document.getElementById("job-epochs").value) || 3,
            batch_size: parseInt(document.getElementById("job-batch").value) || 4,
            learning_rate: document.getElementById("job-lr").value || "2e-4",
        })
    });
    const data = await resp.json();
    if (data.error) { alert(data.error); status.textContent = ""; }
    else { status.textContent = "Job " + (data.job_id || '') + " queued."; setTimeout(() => location.reload(), 1500); }
    btn.disabled = false; btn.textContent = "▶ Start Job";
});

async function checkJobStatus(jobId) {
    const resp = await fetch("/api/rfx/finetune/status?job_id=" + jobId);
    const data = await resp.json();
    if (data.status) { alert("Status: " + data.status + "\n" + (data.message || "")); }
    else { alert(JSON.stringify(data)); }
}
</script>
{% endblock %}
